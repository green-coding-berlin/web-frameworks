  FROM php:8.3-fpm

RUN apt-get -qq update
RUN apt-get -qy install libzip-dev 

WORKDIR /usr/src/app

RUN docker-php-ext-install zip opcache



  RUN docker-php-ext-install sockets


ENV EVENT_EXT_FILE /usr/local/etc/php/conf.d/docker-php-ext-event.ini
RUN if [ -f "${EVENT_EXT_FILE}" ] ; then \
  rm -fr /usr/local/etc/php/conf.d/docker-php-ext-sockets.ini ; \
  sed -i -e '1i extension=sockets.so' /usr/local/etc/php/conf.d/docker-php-ext-event.ini ; fi
  

  COPY 'app/locale/ru/messages.en.php' 'app/locale/ru/messages.en.php'
  COPY 'app/src/Endpoint/Web/Middleware/LocaleSelector.php' 'app/src/Endpoint/Web/Middleware/LocaleSelector.php'
  COPY 'app/src/Endpoint/Web/HomeController.php' 'app/src/Endpoint/Web/HomeController.php'
  COPY 'app/src/Endpoint/Console/DoNothing.php' 'app/src/Endpoint/Console/DoNothing.php'
  COPY 'app/src/Application/Bootloader/LoggingBootloader.php' 'app/src/Application/Bootloader/LoggingBootloader.php'
  COPY 'app/src/Application/Bootloader/ExceptionHandlerBootloader.php' 'app/src/Application/Bootloader/ExceptionHandlerBootloader.php'
  COPY 'app/src/Application/Bootloader/RoutesBootloader.php' 'app/src/Application/Bootloader/RoutesBootloader.php'
  COPY 'app/src/Application/helpers.php' 'app/src/Application/helpers.php'
  COPY 'app/src/Application/Exception/Handler.php' 'app/src/Application/Exception/Handler.php'
  COPY 'app/src/Application/Kernel.php' 'app/src/Application/Kernel.php'
  COPY 'public/index.php' 'public/index.php'
  COPY 'composer.json' 'composer.json'
  COPY '.rr.yaml' '.rr.yaml'


    RUN curl -sSL https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    RUN composer install --no-dev --prefer-dist --classmap-authoritative
    RUN composer dumpautoload -o
    RUN php public/index.php configure
    RUN vendor/bin/rr get-binary

  CMD ./rr serve


