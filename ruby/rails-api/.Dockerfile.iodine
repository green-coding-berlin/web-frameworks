FROM ruby:3.3-slim

WORKDIR /usr/src/app

RUN apt-get -qq update

RUN apt-get -qy install build-essential

  COPY 'app/controllers/api_controller.rb' 'app/controllers/api_controller.rb'
  COPY 'config/routes.rb' 'config/routes.rb'
  COPY 'config/environments/production.rb' 'config/environments/production.rb'
  COPY 'config/environment.rb' 'config/environment.rb'
  COPY 'config/application.rb' 'config/application.rb'
  COPY 'config/puma.rb' 'config/puma.rb'
  COPY 'config/boot.rb' 'config/boot.rb'
  COPY 'config/secrets.yml' 'config/secrets.yml'
  COPY 'config/storage.yml' 'config/storage.yml'
  COPY 'config/database.yml' 'config/database.yml'
  COPY 'Gemfile' 'Gemfile'
  COPY 'Rakefile' 'Rakefile'
  COPY 'config.ru' 'config.ru'

  ENV RACK_ENV=production
  ENV BUNDLE_WITHOUT=development,test
  ENV RAILS_ENV=production
  ENV RAILS_LOG_LEVEL=fatal

RUN bundle install

  RUN mkdir -p tmp/pids
  RUN bundle add iodine

CMD bundle exec iodine -p 3000 -w $(nproc)